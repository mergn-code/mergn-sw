/* Copyright (c) 2025 MERGN */
"use strict";(()=>{var _=Object.defineProperty,I=Object.defineProperties;var v=Object.getOwnPropertyDescriptors;var h=Object.getOwnPropertySymbols;var S=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable;var m=(t,e,i)=>e in t?_(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,E=(t,e)=>{for(var i in e||(e={}))S.call(e,i)&&m(t,i,e[i]);if(h)for(var i of h(e))w.call(e,i)&&m(t,i,e[i]);return t},y=(t,e)=>I(t,v(e));var c=(t,e,i)=>new Promise((d,s)=>{var u=o=>{try{r(i.next(o))}catch(l){s(l)}},a=o=>{try{r(i.throw(o))}catch(l){s(l)}},r=o=>o.done?d(o.value):Promise.resolve(o.value).then(u,a);r((i=i.apply(t,e)).next())});var p,b,f="https://api.mergn.com/sdk-management/api";function N(){return c(this,null,function*(){try{let t=yield self.registration.pushManager.getSubscription();t?(yield t.unsubscribe(),n(1,"Unsubscribed successfully")):n(1,"No subscription found")}catch(t){n(2,(t==null?void 0:t.message)||"Error in unsubscribing push manager")}})}function O(t){return c(this,null,function*(){try{if(n(1,"Updating subscription details"),yield self.registration.pushManager.getSubscription()){n(1,"Existing subscription found");let i=yield(yield fetch(`${f}/brand/get-web-push-public-key`,{headers:{Authorization:"6eebe9bm332rgna9fcfa4cf11a1e3709cac44ff8c0b104bb62fd77d1e5669175d0d2f54","Content-Type":"application/json"},method:"GET"})).json();return yield N(),self.registration.pushManager.subscribe({applicationServerKey:i.data,userVisibleOnly:!0}).then(s=>fetch(`${f}/device/add-device-token`,{body:JSON.stringify({device_id:t,is_web_push_subscribed:!0,web_push_subscription_page_url:"/",web_push_token:{token:JSON.parse(JSON.stringify(s))}}),headers:{Authorization:"6eebe9bm332rgna9fcfa4cf11a1e3709cac44ff8c0b104bb62fd77d1e5669175d0d2f54","Content-Type":"application/json"},method:"PUT"})).catch(s=>{n(2,(s==null?void 0:s.message)||"Error in activate event")})}}catch(e){n(2,(e==null?void 0:e.message)||"Error in activate event")}return{}})}var n=(t,e)=>c(void 0,null,function*(){try{if(!p)return;p<=3&&(t===1?console.info(`INFO: ${new Date().toISOString()}`,e):t===2&&console.error(`ERROR: ${new Date().toISOString()}`,e))}catch(i){console.error((i==null?void 0:i.message)||"Error in logging debug")}}),C=t=>!t.startsWith("http://")&&!t.startsWith("https://")?`http://${t}`:t,g=u=>c(void 0,[u],function*({campaignCustomerInstanceId:t,customerId:e,error:i,eventId:d,name:s}){try{let a={customerId:e,events:[y(E({campaignCustomerInstanceId:t,eventId:d,eventProperties:[]},s?{name:s}:{}),{sessionId:"abcd"})]};try{fetch(`${f}/v2/event/record-event`,{body:JSON.stringify(a),headers:{Authorization:"6eebe9bm332rgna9fcfa4cf11a1e3709cac44ff8c0b104bb62fd77d1e5669175d0d2f54","Content-Type":"application/json"},method:"POST"})}catch(r){n(2,(r==null?void 0:r.message)||"Error in recording event")}n(1,"Recording event:"),n(1,a)}catch(a){n(2,(a==null?void 0:a.message)||"Error in recording event")}});self.addEventListener("message",t=>c(void 0,null,function*(){try{let e=t.data?JSON.parse(t.data):null;e.debugLevel&&(p=e.debugLevel),e.device_id&&(b=e.device_id)}catch(e){console.error("Error processing event:",e)}}));self.addEventListener("push",function(t){return c(this,null,function*(){try{if(t.data){let e=t.data.json();n(1,"Push event data received:"),n(1,e),t.waitUntil(self.registration.showNotification(e.title,e.options)),yield g({campaignCustomerInstanceId:e.options.data.campaignCustomerInstanceId||"",customerId:`${e.options.data.customerId}`,eventId:594,name:"view"}),yield O(e.options.data.deviceId)}}catch(e){n(2,(e==null?void 0:e.message)||"Error in push event")}})});self.addEventListener("notificationclick",function(t){return c(this,null,function*(){var e;try{if(n(1,"Notification click event received:"),n(1,(e=t==null?void 0:t.notification)==null?void 0:e.data),t.notification.close(),t.action!=="action1"){if(t.action!=="action2"){let i=t.notification.data.url;t.waitUntil(clients.matchAll({includeUncontrolled:!0,type:"window"}).then(function(d){let s=null;for(let u=0;u<d.length;u++){let a=d[u];if(a.url===i){s=a;break}}return s?s.focus():clients.openWindow(C(i))})),g({campaignCustomerInstanceId:t.notification.data.campaignCustomerInstanceId||"",customerId:t.notification.data.customerId,eventId:592,name:"click"})}}}catch(i){n(2,(i==null?void 0:i.message)||"Error in notification click event")}})});self.addEventListener("notificationclose",function(t){return c(this,null,function*(){var e;try{n(1,"Notification close event received"),n(1,(e=t==null?void 0:t.notification)==null?void 0:e.data),g({campaignCustomerInstanceId:t.notification.data.campaignCustomerInstanceId||"",customerId:t.notification.data.customerId,eventId:586,name:"close"})}catch(i){n(2,(i==null?void 0:i.message)||"Error in notification close event")}})});self.addEventListener("install",function(t){t.waitUntil(self.skipWaiting())});self.addEventListener("pushsubscriptionchange",t=>c(void 0,null,function*(){if(n(1,`Push subscription change event received: ${JSON.stringify(t)}`),!b)return;let e=self.registration.pushManager.subscribe(t.oldSubscription.options).then(i=>fetch(`${f}/device/add-device-token`,{body:JSON.stringify({device_id:b,is_web_push_subscribed:!0,web_push_subscription_page_url:"/",web_push_token:JSON.parse(JSON.stringify(i))}),headers:{Authorization:"6eebe9bm332rgna9fcfa4cf11a1e3709cac44ff8c0b104bb62fd77d1e5669175d0d2f54","Content-Type":"application/json"},method:"POST"}));t.waitUntil(e)}),!1);})();
